<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Melodymedic - Google Fit Integration</title>
    <link rel="stylesheet" href="/style.css" />
</head>
<body>
    <div class="container">
        <h1>Google Fit Integration</h1>
        <button id="connectButton" onclick="authenticate()">Connect to Google Fit</button>
        <div id="recommendations"></div>
        <div id="mood"></div>
    </div>

    <script>
        const CLIENT_ID = '1006652687935-b511663010kmdiqqe5s4qchnp2him6ad.apps.googleusercontent.com'; // Your Client ID
        const SCOPES = 'https://www.googleapis.com/auth/fitness.activity.read https://www.googleapis.com/auth/fitness.heart_rate.read'; // Valid scopes
        const REDIRECT_URI = 'http://localhost:5500'; // Change to your redirect URI

        function authenticate() {
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=${encodeURIComponent(SCOPES)}`;
            window.location.href = authUrl;
        }

        async function handleAuthResult(authResult) {
            if (authResult && !authResult.error) {
                const accessToken = authResult.access_token;
                await fetchGoogleFitData(accessToken);
            } else {
                console.error('Error during authentication', authResult.error);
            }
        }

        async function fetchGoogleFitData(accessToken) {
            // Fetch heart rate data
            const response = await fetch('https://www.googleapis.com/fitness/v1/users/me/dataset:aggregate', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    aggregateBy: [{
                        dataTypeName: 'com.google.heart_rate.bpm',
                        dataSourceId: 'derived:com.google.heart_rate.bpm:com.google.android.gms:merge_heart_rate_bpm'
                    }],
                    bucketByTime: { durationMillis: 86400000 }, 
                    startTimeMillis: Date.now() - 86400000, 
                    endTimeMillis: Date.now(),
                })
            });

            const data = await response.json();
            if (data.bucket && data.bucket.length > 0) {
                const heartRateData = data.bucket.map(bucket => {
                    return bucket.dataset[0].point.map(point => point.value[0].fpVal); // Get heart rate values
                }).flat();
                displayMusicRecommendations(heartRateData);
                displayMood(heartRateData);
            } else {
                console.log('No heart rate data found.');
                displayMood([]); // Clear mood display if no data
            }
        }

        function displayMusicRecommendations(heartRateData) {
            const recommendationsContainer = document.getElementById('recommendations');
            recommendationsContainer.innerHTML = ''; // Clear previous recommendations

            heartRateData.forEach(heartRate => {
                const musicItem = document.createElement('div');
                musicItem.innerText = `Recommended music for heart rate: ${heartRate} bpm`; // Customize this message
                recommendationsContainer.appendChild(musicItem);
            });
        }

        function displayMood(heartRateData) {
            const moodContainer = document.getElementById('mood');
            moodContainer.innerHTML = ''; // Clear previous mood

            if (heartRateData.length === 0) {
                moodContainer.innerText = "No heart rate data available for mood analysis.";
                return;
            }

            heartRateData.forEach(heartRate => {
                const mood = assessMood(heartRate);
                const moodItem = document.createElement('div');
                moodItem.innerText = `Your current mood based on heart rate: ${mood}`;
                moodContainer.appendChild(moodItem);
            });
        }

        function assessMood(heartRate) {
            // Define mood based on heart rate ranges
            if (heartRate < 60) {
                return "Relaxed"; // Heart rate indicates a relaxed state
            } else if (heartRate >= 60 && heartRate < 80) {
                return "Calm"; // Moderate heart rate indicates calmness
            } else if (heartRate >= 80 && heartRate < 100) {
                return "Energized"; // Elevated heart rate suggests energy
            } else {
                return "Stressed"; // High heart rate indicates stress
            }
        }

        // Check if there is an access token in the URL
        const hash = window.location.hash.substr(1);
        if (hash) {
            const authResult = {};
            hash.split('&').forEach(function(item) {
                const parts = item.split('=');
                authResult[decodeURIComponent(parts[0])] = decodeURIComponent(parts[1]);
            });
            handleAuthResult(authResult);
        }
    </script>
</body>
</html>
